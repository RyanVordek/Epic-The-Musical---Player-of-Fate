<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EPIC Player - The Player Edition</title>
  
  <style>
    /* === VARIÁVEIS E RESET === */
    :root {
      --bg-base: #1a0b08;
      --accent: #d97706; /* Laranja Padrão */
      --text: #fff7ed;
      --muted: #a8a29e;
      --glass: rgba(20, 10, 5, 0.7);
      --stroke: rgba(255, 255, 255, 0.15);
      --radius: 24px;
      --progress-width: 0%;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; overflow-x: hidden; }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      color: var(--text);
      background: #000;
      transition: background 1s ease;
    }

    /* === CAMADAS DE FUNDO === */
    #sagaBackground {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: -2; pointer-events: none; overflow: hidden;
    }

    #waterCanvas {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: -1; pointer-events: none; opacity: 0.6; display: none;
    }

    /* === SAGA CYCLOPS (OLHO) === */
    #saga-cyclops {
        position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
        background: radial-gradient(circle, #2a0505 0%, #000 70%);
        animation: fadeInRed 2s ease; z-index: 1;
    }
    .eye-container { position: relative; width: 300px; height: 300px; display: flex; align-items: center; justify-content: center; }
    .eye-shape {
        width: 0; height: 0; background: #000; border-radius: 50%; position: relative;
        box-shadow: 0 0 60px rgba(255, 0, 0, 0.2); border: 2px solid rgba(139, 0, 0, 0.5);
        animation: openEye 3s cubic-bezier(0.25, 1, 0.5, 1) forwards; overflow: hidden;
    }
    .eye-iris {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 60%; height: 60%; border-radius: 50%;
        background: radial-gradient(circle, #ff4444 0%, #8b0000 70%, #000 100%);
        box-shadow: inset 0 0 20px #000;
    }
    .eye-pupil {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 30%; height: 100%; background: #000; border-radius: 50%;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
    }
    .eye-glow {
        position: absolute; inset: -50px; z-index: -1;
        background: radial-gradient(circle, rgba(255, 0, 0, 0.1) 0%, transparent 60%);
        animation: pulseRed 3s infinite alternate;
    }
    @keyframes openEye { 0% { width: 0; height: 0; opacity: 0; } 50% { width: 280px; height: 10px; opacity: 1; } 100% { width: 280px; height: 280px; } }
    @keyframes pulseRed { 0% { opacity: 0.3; transform: scale(1); } 100% { opacity: 0.8; transform: scale(1.2); } }
    @keyframes fadeInRed { from { opacity: 0; background: #000; } to { opacity: 1; } }

    /* === SAGA UNDERWORLD (RIO 3D) === */
    #saga-underworld {
        position: absolute; inset: 0; overflow: hidden; background: #050505; z-index: 1;
    }
    .styx-scene { position: absolute; width: 100%; height: 100%; perspective: 800px; overflow: hidden; }
    .styx-river {
        position: absolute; left: -50%; width: 200%; height: 200%; top: 50%;
        background: repeating-linear-gradient(180deg, #0a0a1a 0%, #11112b 20%, #050510 40%);
        transform-origin: 50% 0; transform: rotateX(70deg) translateY(-50px);
        box-shadow: inset 0 0 100px #000; animation: riverFlow 10s linear infinite; opacity: 0.6;
    }
    #underworldCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
    @keyframes riverFlow { 0% { background-position: 0 0; } 100% { background-position: 0 500px; } }

    /* === TROY (CONSTELAÇÃO) === */
    .constellation-svg {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 80%; height: 80%; opacity: 0.4; filter: drop-shadow(0 0 10px gold); z-index: 1;
    }
    .constellation-path { fill: none; stroke: gold; stroke-width: 2; stroke-linecap: round; }
    .star-point { fill: white; filter: blur(1px); animation: twinkle 3s infinite ease-in-out; }
    @keyframes twinkle { 0%, 100% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.5); } }

    /* === LAYOUT E VIDRO === */
    .glass {
      background: var(--glass); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
      border: 1px solid var(--stroke); border-radius: var(--radius);
    }
    .main-container { 
        position: relative; z-index: 10; max-width: 1200px; margin: 0 auto; 
        padding-bottom: 120px; animation: fadeIn 1s ease; 
    }
    .intro { 
        position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; 
        z-index: 3000; background: radial-gradient(circle at center, rgba(45, 27, 20, 0.4) 0%, #000 100%);
        backdrop-filter: blur(10px); transition: opacity 0.8s ease-out; 
    }
    .intro-card { 
        padding: 60px 40px; text-align: center; width: 90%; max-width: 600px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        background: linear-gradient(135deg, rgba(27, 20, 15, 0.8), rgba(30, 25, 20, 0.6))); border: 1px solid rgba(217, 119, 6, 0.3); 
        border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        animation: floatCard 6s ease-in-out infinite;
    }
    .intro h1 { 
        font-size: clamp(2.5rem, 8vw, 5rem); margin-bottom: 10px; color: var(--accent); 
        text-transform: uppercase; line-height: 1;
        background: linear-gradient(to bottom, #fff7ed 0%, var(--accent) 70%, #7c2d12 100%);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .intro-btn { 
        border-radius: 50px; padding: 20px 50px; font-weight: 800; text-transform: uppercase; cursor: pointer; border: none;
        background: linear-gradient(180deg, rgba(217, 119, 6, 0.2) 0%, rgba(0,0,0,0.8) 100%);
        color: #fff; margin-top: 30px; width: auto; font-size: 1.1rem; transition: 0.3s;
    }
    .intro-btn:hover { transform: scale(1.05); background: var(--accent); color: #000; }

    /* === PLAYER === */
    .hero { display: grid; grid-template-columns: 1fr 1fr; gap: 60px; padding: 40px; margin: 40px 20px; align-items: center; }
    .hero-text { color: #fff; }
    .nowplaying { padding: 30px; margin-top: 30px; border-radius: 20px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05); }
    .np-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .np-title { font-size: 1.5rem; font-weight: 800; color: var(--accent); }
    .saga-badge { background: var(--accent); color: #000; padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 0.8rem; text-transform: uppercase; }

    .timeline-container { display: flex; align-items: center; gap: 15px; font-size: 0.8rem; color: var(--muted); margin-bottom: 25px; }
    #progressSlider { flex: 1; height: 6px; appearance: none; background: rgba(255,255,255,0.1); border-radius: 3px; cursor: pointer; background-image: linear-gradient(to right, var(--accent) var(--progress-width), rgba(255,255,255,0.1) var(--progress-width)); background-repeat: no-repeat; }
    #progressSlider::-webkit-slider-thumb { appearance: none; width: 12px; height: 12px; background: #fff; border-radius: 50%; box-shadow: 0 0 10px var(--accent); }

    /* CONTROLES */
    .controls-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
    .main-controls { display: flex; gap: 15px; align-items: center; justify-content: center; flex: 1; }
    .btn.icon-btn { background: transparent; border: none; color: #fff; cursor: pointer; padding: 10px; border-radius: 50%; transition: 0.2s; display: flex; align-items: center; justify-content: center; width: 45px; height: 45px; }
    .btn.icon-btn:hover { background: rgba(255,255,255,0.1); color: var(--accent); }
    .btn.icon-btn svg { width: 24px; height: 24px; }
    .btn.primary.big-play { width: 70px; height: 70px; border-radius: 50%; background: var(--accent); border: none; color: #000; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px var(--accent); transition: 0.3s; }
    .btn.primary.big-play:hover { transform: scale(1.1); background: #fff; }
    .btn.primary.big-play svg { width: 32px; height: 32px; fill: currentColor; }

    .volume-control { display: flex; align-items: center; gap: 10px; width: 130px; background: rgba(0,0,0,0.3); padding: 10px 15px; border-radius: 30px; }
    #volumeSlider { width: 100%; height: 4px; appearance: none; background: rgba(255,255,255,0.2); border-radius: 2px; }
    
    /* VINIL */
    .hero-player { display: flex; justify-content: center; align-items: center; perspective: 1200px; position: relative; }
    .player-scene { position: relative; width: 380px; height: 380px; display: flex; align-items: center; justify-content: center; }
    .vinyl-disk {
      width: 340px; height: 340px; border-radius: 50%; background: #101010; position: relative; 
      box-shadow: 0 40px 80px rgba(0,0,0,0.6); z-index: 2; border: 4px solid #050505;
      animation: spin 4s linear infinite; animation-play-state: paused; margin: 0 auto; 
    }
    .vinyl-disk.spinning { animation-play-state: running; }
    .vinyl-label { position: absolute; inset: 0; margin: auto; width: 35%; height: 35%; border-radius: 50%; overflow: hidden; border: 2px solid rgba(255,255,255,0.1); background: #333; z-index: 3; }
    .vinyl-label img { width: 100%; height: 100%; object-fit: cover; }
    
    /* LETRAS E LISTA */
    .lyrics-panel { display: none; margin: 15px 0; height: 140px; overflow-y: auto; text-align: center; background: rgba(0, 0, 0, 0.4); border-radius: 12px; mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent); }
    body.lyrics-active .lyrics-panel { display: block; animation: slideOpen 0.3s ease; }
    .l-line { padding: 6px; color: var(--muted); opacity: 0.5; transition: 0.3s; }
    .l-line.active { color: #fff; font-size: 1.1rem; opacity: 1; font-weight: bold; text-shadow: 0 0 10px var(--accent); }

    .section { padding: 20px; }
    .tracks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; padding: 0 20px; }
    .track { padding: 15px; border-radius: 12px; background: rgba(20, 20, 20, 0.6); border: 1px solid transparent; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
    .track:hover { background: rgba(255,255,255,0.08); border-color: var(--accent); }
    .track.active { background: var(--accent); color: #000; font-weight: 800; box-shadow: 0 0 20px var(--accent); }

    /* MODAL */
    .modal { position: fixed; inset: 0; z-index: 2100; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(5px); }
    .modal.show { opacity: 1; pointer-events: auto; }
    .modal-content { background: #151515; padding: 40px; border-radius: 24px; width: 90%; max-width: 450px; border: 1px solid #333; text-align: center; }
    .stat-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #333; color: #aaa; }
    .highlight { color: #fff; font-weight: bold; }
    .achievement-toast { position: fixed; bottom: 30px; right: 30px; background: #222; border-left: 5px solid var(--accent); color: #fff; padding: 15px 25px; border-radius: 8px; z-index: 2000; animation: slideInRight 0.5s ease; }

    @keyframes spin { 100% { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideOpen { from { height: 0; opacity: 0; } to { height: 140px; opacity: 1; } }
    @keyframes floatCard { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    /* MOBILE */
    @media (max-width: 950px) {
        .hero { display: flex; flex-direction: column; text-align: center; gap: 40px; padding: 20px; margin: 10px; }
        .hero-player { order: -1; transform: scale(0.9); }
        .controls-row { justify-content: center; flex-direction: column; }
        .volume-control { width: 100%; max-width: 300px; }
    }
  </style>
</head>
<body>
  
  <div id="sagaBackground">
      <svg id="saga-troy" class="constellation-svg" viewBox="0 0 500 500" style="display: none;">
          <path id="horsePath" class="constellation-path" d="M100,420 L140,350 L130,250 L180,150 L230,80 L280,100 L340,180 L330,280 L400,350 M230,80 L200,40 L260,45 L230,80" />
          <circle cx="100" cy="420" r="3" class="star-point" /><circle cx="140" cy="350" r="4" class="star-point" style="animation-delay: 1s" />
          <circle cx="180" cy="150" r="5" class="star-point" style="animation-delay: 0.5s" /><circle cx="230" cy="80"  r="4" class="star-point" style="animation-delay: 1.5s" />
          <circle cx="340" cy="180" r="4" class="star-point" style="animation-delay: 0.2s" />
      </svg>
      <div id="saga-cyclops" style="display: none;">
          <div class="eye-container">
              <div class="eye-shape"><div class="eye-iris"><div class="eye-pupil"></div></div></div>
              <div class="eye-glow"></div>
          </div>
      </div>
      <div id="saga-underworld" style="display: none;">
          <div class="styx-scene"><div class="styx-river"></div></div>
          <canvas id="underworldCanvas"></canvas> 
      </div>
  </div>
  <canvas id="waterCanvas"></canvas>

  <div id="statsModal" class="modal">
      <div class="modal-content">
          <h2>Suas Estatísticas</h2>
          <div class="stat-row"><span>Música Mais Ouvida:</span><strong id="statMostPlayed" class="highlight">...</strong></div>
          <div class="stat-row"><span>Total de Plays:</span><strong id="statTotalPlays" class="highlight">0</strong></div>
          <div class="stat-row"><span>Conquistas:</span><strong id="statBadges" class="highlight">0</strong></div>
          <button class="intro-btn" id="closeStats" style="margin-top: 20px; width: 100%; font-size: 1rem;">Fechar</button>
      </div>
  </div>

  <div class="intro" id="intro">
    <div class="glass intro-card">
      <h1>EPIC The Musical</h1>
      <p>Saga Completa • Vinyl Edition</p>
      <button class="intro-btn" onclick="startExperience()">Iniciar A Odisseia</button>
      <p style="margin-top: 20px; font-size: 0.9rem; opacity: 0.6;">By RyanVordek</p>
    </div>
  </div>

  <div class="main-container" id="mainContent" hidden>
    <header class="hero glass">
      <div class="hero-text">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
            <div><h2>EPIC: The Musical</h2><p>Player Interativo • Audio HQ</p></div>
            <button class="btn icon-btn" id="statsBtn" title="Ver Conquistas"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg></button>
        </div>
        
        <div class="nowplaying">
          <div class="np-header">
            <span class="np-title" id="currentTitle">Selecione uma faixa</span>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span id="currentSaga" class="saga-badge">Saga</span>
                <button class="btn icon-btn" id="lyricsBtn" title="Letra"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path></svg></button>
                <button class="btn icon-btn" id="favBtn" title="Favoritar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></button>
            </div>
          </div>
          
          <div class="timeline-container">
             <span id="currentTime">00:00</span>
             <input type="range" id="progressSlider" min="0" max="100" value="0" step="0.1">
             <span id="totalTime">00:00</span>
          </div>
          
          <div class="controls-row">
            <div class="main-controls">
                <button class="btn icon-btn" id="shuffleBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg></button>
                <button class="btn icon-btn" id="prevBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg></button>
                <button class="btn primary big-play" id="playPauseBtn">
                    <svg id="iconPlay" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    <svg id="iconPause" viewBox="0 0 24 24" style="display:none;"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                </button>
                <button class="btn icon-btn" id="nextBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg></button>
                <button class="btn icon-btn" id="loopBtn" title="Loop"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg></button>
            </div>
            <div class="volume-control">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="1">
            </div>
          </div>
          <div id="lyricsContent" class="lyrics-panel"><div class="lyrics-placeholder">...</div></div>
        </div>
      </div>

      <div class="hero-player">
        <div class="player-scene">
          <div class="vinyl-disk" id="vinylDisk">
            <div class="vinyl-grooves"></div><div class="vinyl-shine"></div>
            <div class="vinyl-label"><img id="albumCover" src="" alt="Capa" /></div><div class="vinyl-hole"></div>
          </div>
          <img id="stickerCharacter" class="character-popup" src="" alt="" />
        </div>
      </div>
    </header>

    <main class="section">
        <div class="section-head"><h3 style="color:#fff;">Lista de Faixas</h3></div>
        <div class="tracks-grid" id="tracksGrid"></div>
    </main>
    <footer style="text-align:center; padding: 20px; color: #555;"><p>Desenvolvido por RyanVordek</p></footer>
  </div>

  <audio id="audioEl" preload="metadata"></audio>

  <script>
    /* DADOS E LISTAS */
    const themeBySaga = {
        Troy:       { bg: "#2d1b14", accent: "#fbbf24" },
        Cyclops:    { bg: "#450a0a", accent: "#ef4444" },
        Ocean:      { bg: "#082f49", accent: "#38bdf8" },
        Circe:      { bg: "#581c87", accent: "#f0abfc" },
        Underworld: { bg: "#111827", accent: "#9ca3af" },
        Thunder:    { bg: "#713f12", accent: "#facc15" },
        Wisdom:     { bg: "#312e81", accent: "#a78bfa" },
        Vengeance:  { bg: "#064e3b", accent: "#34d399" },
        Ithaca:     { bg: "#7f1d1d", accent: "#fb7185" },
    };

    const tracks = [
      { title: "The Horse and the Infant", saga: "Troy", index: 1, id: "bWIgy-Ls-SU", stickers: [0,1,2,3] },
      { title: "Just a Man", saga: "Troy", index: 2, id: "hNdvp9Qo8PA", stickers: [4,5,6] },
      { title: "Full Speed Ahead", saga: "Troy", index: 3, id: "x3KOt-3T73c", stickers: [7,8,9] },
      { title: "Open Arms", saga: "Troy", index: 4, id: "-oMZw8DQbaI", stickers: [10,11,12] },
      { title: "Warrior of the Mind", saga: "Troy", index: 5, id: "oB8lqgO9e24", stickers: [13,14,15] },
      { title: "Polyphemus", saga: "Cyclops", index: 6, id: "nDQyFHmuQls", stickers: [16,17,18] },
      { title: "Survive", saga: "Cyclops", index: 7, id: "rND9-qeA7Lo", stickers: [19,20,21] },
      { title: "Remember Them", saga: "Cyclops", index: 8, id: "NGxrhdgAg18", stickers: [22,23] },
      { title: "My Goodbye", saga: "Cyclops", index: 9, id: "xrFaGilus6o", stickers: [24,25] },
      { title: "Storm", saga: "Ocean", index: 10, id: "sRntPU_s-gI", stickers: [26,27,28] },
      { title: "Luck Runs Out", "saga": "Ocean", index: 11, id: "ZxQHl2fVJ-s", stickers: [29,30] },
      { title: "Keep Your Friends Close", "saga": "Ocean", index: 12, id: "Z-Y0iMmFzFE", stickers: [31,32] },
      { title: "Ruthlessness", saga: "Ocean", index: 13, id: "3dzBlSeCJNg", stickers: [33,34] },
      { title: "Puppeteer", saga: "Circe", index: 14, id: "Mz2ASoe6OG0", stickers: [35,36] },
      { title: "Wouldn't You Like", saga: "Circe", index: 15, id: "xkIBM71E0_w", stickers: [37,38] },
      { title: "Done For", saga: "Circe", index: 16, id: "km6NITbLVHc", stickers: [39,40] },
      { title: "There Are Other Ways", "saga": "Circe", index: 17, id: "uXdLAOBANGE", stickers: [41,42] },
      { title: "The Underworld", saga: "Underworld", index: 18, "id": "cyqul8pKHko", stickers: [43,44] },
      { title: "No Longer You", saga: "Underworld", index: 19, "id": "BZ8qL5P270Q", stickers: [45,46] },
      { title: "Monster", saga: "Underworld", index: 20, "id": "4Q0Un9PQ0wk", stickers: [47,48] },
      { title: "Suffering", saga: "Thunder", index: 21, "id": "-u_-wpcpY-0", stickers: [49,50] },
      { title: "Different Beast", saga: "Thunder", index: 22, "id": "x2r7dKWFbP8", stickers: [51,52] },
      { title: "Scylla", saga: "Thunder", index: 23, "id": "PTGWC85tLfg", stickers: [53,54] },
      { title: "Mutiny", saga: "Thunder", index: 24, "id": "x_xJEfDB7y0", stickers: [55,56] },
      { title: "Thunder Bringer", saga: "Thunder", index: 25, "id": "cAId1J7msWI", stickers: [57,58] },
      { title: "Legendary", saga: "Wisdom", index: 26, "id": "Z9NNit-z8wE", stickers: [59,60] },
      { title: "Little Wolf", saga: "Wisdom", index: 27, "id": "-gqU2V1snnc", stickers: [61,62] },
      { title: "We'll Be Fine", saga: "Wisdom", index: 28, "id": "3pIXn3zHkpc", stickers: [63,64] },
      { title: "Love in Paradise", saga: "Wisdom", index: 29, "id": "jWOpikivhbQ", stickers: [65,66] },
      { title: "God Games", saga: "Wisdom", index: 30, "id": "5m3Xe7iDivk", stickers: [67,68] },
      { title: "Not Sorry for Loving You", saga: "Vengeance", index: 31, "id": "7M3gzo-hSCo", stickers: [69,70] },
      { title: "Dangerous", saga: "Vengeance", index: 32, "id": "jZW2GnEcjpM", stickers: [71,72] },
      { title: "Charybdis", saga: "Vengeance", index: 33, "id": "4n0U1Erga90", stickers: [73,74] },
      { title: "Get in the Water", saga: "Vengeance", index: 34, "id": "8njnTRKGdYw", stickers: [75,76] },
      { title: "Six Hundred Strike", saga: "Vengeance", index: 35, "id": "T3rnBuSTNhY", stickers: [77,78] },
      { title: "The Challenge", saga: "Ithaca", index: 36, "id": "Bb6ssHUxrNk", stickers: [79,80] },
      { title: "Hold Them Down", saga: "Ithaca", index: 37, "id": "oeDDZNKHOVo", stickers: [81,82] },
      { title: "Odysseus", saga: "Ithaca", index: 38, "id": "UjcV3CYfCsM", stickers: [83,84] },
      { title: "I Can't Help but Wonder", saga: "Ithaca", index: 39, "id": "FBfT0E6oF6I", stickers: [85,86] },
      { title: "Would You Fall in Love with Me Again", saga: "Ithaca", index: 40, "id": "rF5tJ8xuaIc", stickers: [87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109] }
    ];

    /* VISUAIS (BACKGROUNDS) */
    class RippleRenderer {
        constructor() {
            this.canvas = document.getElementById('waterCanvas'); this.ctx = this.canvas.getContext('2d');
            this.ripples = []; this.active = false; this.resize();
            window.addEventListener('resize', () => this.resize());
            setInterval(() => { if(this.active && !document.hidden) this.addRipple(Math.random()*this.width, Math.random()*this.height); }, 400);
            this.loop();
        }
        resize() { this.width = window.innerWidth; this.height = window.innerHeight; this.canvas.width = this.width; this.canvas.height = this.height; }
        addRipple(x,y) { this.ripples.push({x,y,age:0,size:2,power:1}); }
        loop() {
            if(this.active) {
                this.ctx.clearRect(0,0,this.width,this.height); this.ctx.fillStyle="rgba(8,47,73,0.1)"; this.ctx.fillRect(0,0,this.width,this.height);
                for(let i=0; i<this.ripples.length; i++) {
                    let r=this.ripples[i]; r.age++; r.size+=1.5; r.power-=0.01;
                    if(r.power<=0) { this.ripples.splice(i,1); i--; continue; }
                    this.ctx.beginPath(); this.ctx.ellipse(r.x,r.y,r.size,r.size*0.5,0,0,Math.PI*2);
                    this.ctx.strokeStyle=`rgba(100,200,255,${r.power*0.4})`; this.ctx.lineWidth=2; this.ctx.stroke();
                }
            }
            requestAnimationFrame(()=>this.loop());
        }
    }

    class UnderworldRenderer {
        constructor() {
            this.canvas=document.getElementById('underworldCanvas'); this.ctx=this.canvas.getContext('2d');
            this.souls=[]; this.boatStars=[]; this.active=false; this.createBoatShape(); this.resize();
            window.addEventListener('resize',()=>this.resize());
        }
        resize() { this.width=window.innerWidth; this.height=window.innerHeight; this.canvas.width=this.width; this.canvas.height=this.height; }
        createBoatShape() {
            for(let i=-60; i<=60; i+=5) { this.boatStars.push({x:i,y:Math.pow(i/30,2)*10,size:Math.random()*2+1}); if(Math.abs(i)<2) for(let m=0;m<50;m+=5) this.boatStars.push({x:i,y:-m,size:1}); }
        }
        loop() {
            if(!this.active) return;
            this.ctx.clearRect(0,0,this.width,this.height); const time=Date.now()*0.001;
            const bx=this.width/2; const by=this.height/2+Math.sin(time)*10;
            this.ctx.fillStyle="#fff"; this.ctx.shadowBlur=10; this.ctx.shadowColor="cyan";
            this.boatStars.forEach(s=>{
                this.ctx.beginPath(); this.ctx.arc(bx+s.x+Math.cos(time*2+s.y)*2, by+s.y+Math.sin(time*3+s.x)*2, s.size,0,Math.PI*2); this.ctx.fill();
            });
            this.ctx.shadowBlur=0;
            if(this.souls.length<50) this.souls.push({x:Math.random()*this.width,y:Math.random()>0.5?this.height+10:-10,speed:Math.random()*1+0.5,size:Math.random()*3+1,alpha:0});
            this.souls.forEach((s,i)=>{
                const dx=bx-s.x, dy=by-s.y, dist=Math.sqrt(dx*dx+dy*dy);
                s.x+=(dx/dist)*s.speed; s.y+=(dy/dist)*s.speed;
                s.alpha = dist>200 ? Math.min(s.alpha+0.01,0.6) : Math.max(0,(dist-10)/200);
                this.ctx.beginPath(); this.ctx.fillStyle=`rgba(100,200,255,${s.alpha})`; this.ctx.arc(s.x,s.y,s.size,0,Math.PI*2); this.ctx.fill();
                if(dist<10) this.souls.splice(i,1);
            });
            requestAnimationFrame(()=>this.loop());
        }
    }

    /* GERENCIADORES */
    const BackgroundManager = {
        currentSaga: null,
        init() {
            this.water = new RippleRenderer(); this.underworld = new UnderworldRenderer();
            this.troySvg = document.getElementById('saga-troy'); this.troyPath = document.getElementById('horsePath');
            this.cyclopsDiv = document.getElementById('saga-cyclops'); this.underworldDiv = document.getElementById('saga-underworld');
            if(this.troyPath) { this.pathLength = this.troyPath.getTotalLength(); this.troyPath.style.strokeDasharray = this.pathLength; }
        },
        setSaga(sagaName) {
            if(this.currentSaga === sagaName) return; this.currentSaga = sagaName;
            this.water.active = false; this.underworld.active = false;
            this.troySvg.style.display = 'none'; this.cyclopsDiv.style.display = 'none'; this.underworldDiv.style.display = 'none';
            document.getElementById('waterCanvas').style.display = 'none';
            
            if(sagaName === 'Troy') { this.troySvg.style.display='block'; this.troyPath.style.strokeDashoffset=this.pathLength; }
            else if(sagaName === 'Cyclops') { this.cyclopsDiv.style.display='flex'; const eye=this.cyclopsDiv.querySelector('.eye-shape'); eye.style.animation='none'; eye.offsetHeight; eye.style.animation='openEye 3s forwards'; }
            else if(sagaName === 'Ocean' || sagaName === 'Vengeance') { this.water.active=true; document.getElementById('waterCanvas').style.display='block'; }
            else if(sagaName === 'Underworld') { this.underworldDiv.style.display='block'; this.underworld.active=true; this.underworld.loop(); }
        },
        updateAnimation(time, duration) {
            if(this.currentSaga === 'Troy' && duration) {
                this.troyPath.style.strokeDashoffset = this.pathLength - (this.pathLength * (time/duration));
            }
        }
    };

    const StatsManager = {
        data: { plays:{}, achievements:[], totalPlays:0, favCount:0 },
        load() { const s=localStorage.getItem('epic_stats'); if(s) this.data=JSON.parse(s); },
        save() { localStorage.setItem('epic_stats', JSON.stringify(this.data)); },
        logPlay(t) { this.data.plays[t.id]=(this.data.plays[t.id]||0)+1; this.data.totalPlays++; this.save(); },
        toggleFav(t) { 
            const k='fav_'+t.id; const is=!(localStorage.getItem(k)==='true'); 
            localStorage.setItem(k,is); is?this.data.favCount++:this.data.favCount--; this.save(); return is; 
        },
        isFav(id) { return localStorage.getItem('fav_'+id)==='true'; },
        updateUI() {
            let top={id:null,c:0}; for(let id in this.data.plays) if(this.data.plays[id]>top.c) top={id,c:this.data.plays[id]};
            const t=tracks.find(tr=>tr.id===top.id);
            document.getElementById('statMostPlayed').innerText = t ? `${t.title} (${top.c}x)` : "-";
            document.getElementById('statTotalPlays').innerText = this.data.totalPlays;
        }
    };

    /* PLAYER PRINCIPAL */
    let currentIndex = 0;
    let isShuffle = false;
    let isLoop = false;
    const audio = document.getElementById('audioEl');
    const playBtn = document.getElementById('playPauseBtn');
    
    function startExperience() {
        document.getElementById('intro').style.opacity = '0';
        setTimeout(() => { document.getElementById('intro').style.display='none'; document.getElementById('mainContent').hidden=false; loadTrack(0); }, 500);
        StatsManager.load(); BackgroundManager.init();
    }

    function loadTrack(index) {
        if(index<0 || index>=tracks.length) return;
        currentIndex = index; const t = tracks[index];
        StatsManager.logPlay(t); BackgroundManager.setSaga(t.saga);
        
        document.getElementById('currentTitle').innerText = `${t.index}. ${t.title}`;
        document.getElementById('currentSaga').innerText = t.saga;
        
        // Cores
        const th = themeBySaga[t.saga] || themeBySaga.Troy;
        document.documentElement.style.setProperty('--accent', th.accent);
        document.body.style.background = `radial-gradient(circle at center, ${th.bg}, #000)`;

        audio.src = `Audio/${t.title} [${t.id}].opus`;
        document.getElementById('albumCover').src = `Covers/${t.id}.jpg`;

        // Reset
        document.getElementById('vinylDisk').classList.remove('spinning');
        updatePlayIcon(false);
        
        // Sticker Logic Simples
        const sticker = document.getElementById('stickerCharacter');
        if(t.stickers && t.stickers.length > 0) {
            sticker.src = `Kaohto/Kaohto2023-${t.stickers[0]}.webp`;
            sticker.classList.remove('hide');
        } else sticker.classList.add('hide');

        // Atualizar lista
        renderList();
    }

    function togglePlay() {
        if(audio.paused) { audio.play(); document.getElementById('vinylDisk').classList.add('spinning'); updatePlayIcon(true); }
        else { audio.pause(); document.getElementById('vinylDisk').classList.remove('spinning'); updatePlayIcon(false); }
    }

    function updatePlayIcon(isPlaying) {
        document.getElementById('iconPlay').style.display = isPlaying ? 'none':'block';
        document.getElementById('iconPause').style.display = isPlaying ? 'block':'none';
    }

    function changeTrack(offset) {
        let next = currentIndex + offset;
        if(isShuffle && offset === 1) next = Math.floor(Math.random()*tracks.length);
        if(next >= tracks.length) next = 0; if(next < 0) next = tracks.length - 1;
        loadTrack(next); setTimeout(togglePlay, 100);
    }

    // Controles
    playBtn.onclick = togglePlay;
    document.getElementById('nextBtn').onclick = () => changeTrack(1);
    document.getElementById('prevBtn').onclick = () => changeTrack(-1);
    
    document.getElementById('loopBtn').onclick = () => {
        isLoop = !isLoop; audio.loop = isLoop;
        document.getElementById('loopBtn').style.color = isLoop ? 'var(--accent)' : '#fff';
    };
    
    document.getElementById('shuffleBtn').onclick = () => {
        isShuffle = !isShuffle;
        document.getElementById('shuffleBtn').style.color = isShuffle ? 'var(--accent)' : '#fff';
    };

    document.getElementById('favBtn').onclick = () => {
        const is = StatsManager.toggleFav(tracks[currentIndex]);
        document.getElementById('favBtn').style.color = is ? 'var(--accent)' : '#fff';
    };

    document.getElementById('closeStats').onclick').onclick = () => { StatsManager.updateUI(); document.getElementById('statsModal').classList.add('show'); };
    document.getElementById('closeStats').onclick = () => document.getElementById('statsModal').classList.remove('show');

    // Audio Events
    audio.ontimeupdate = () => {
        if(!audio.duration) return;
        const pct = (audio.currentTime/audio.duration)*100;
        document.getElementById('progressSlider').value = pct;
        document.documentElement.style.setProperty('--progress-width', pct+'%');
        document.getElementById('currentTime').innerText = fmtTime(audio.currentTime);
lyricsBtn        BackgroundManager.updateAnimation(audio.currentTime, audio.duration);
    };
    
    audio.onended = () => { if(!isLoop) changeTrack(1); };
    
    document.getElementById('progressSlider').oninput = (e) => {
        audio.currentTime = (e.target.value/100)*audio.duration;
    };

    function fmtTime(s) { const m=Math.floor(s/60), sec=Math.floor(s%60); return `${m}:${sec<10?'0'+sec:sec}`; }

    function renderList() {
        const g = document.getElementById('tracksGrid'); g.innerHTML = '';
        tracks.forEach((t, i) => {
            const d = document.createElement('div'); d.className = `track ${i===currentIndex?'active':''}`;
            d.innerHTML = `<div>${t.index}. ${t.title}</div><small>${t.saga}</small>`;
audio.ontimeupdate
    g.appendChild(d);
        });
    }

    // Fallback error
    audio.onerror = () => {
        console.log("Tentando fallback mp3...");
        const t = tracks[currentIndex];
        if(audio.src.includes(".opus")) { audio.src = `Audio/${t.title} [${t.id}].mp3`; audio.play(); }
    };
     /* FIX BUTTONS AND EVENTS */
 document.getElementById('lyricsBtn').onclick = () => { document.body.classList.toggle('lyrics-active'); };
 document.getElementById('volumeSlider').oninput = (e) => { audio.volume = parseFloat(e.target.value); };
 

  </script>
</body>
</html>
